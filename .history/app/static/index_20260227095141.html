<!doctype html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>GLM-OCR Local Console</title>
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=M+PLUS+1p:wght@400;500;700&display=swap"
			rel="stylesheet"
		/>
		<style>
			:root {
				--bg-start: #fff6e8;
				--bg-end: #ecf9f6;
				--panel: rgba(255, 255, 255, 0.88);
				--panel-strong: #ffffff;
				--ink: #1f2937;
				--muted: #556070;
				--line: #d8e1ea;
				--accent: #0f766e;
				--accent-strong: #115e59;
				--warn: #b45309;
				--mono: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, monospace;
				--sans: "M PLUS 1p", "Hiragino Kaku Gothic ProN", sans-serif;
			}

			* {
				box-sizing: border-box;
			}

			body {
				margin: 0;
				min-height: 100vh;
				font-family: var(--sans);
				color: var(--ink);
				background: linear-gradient(140deg, var(--bg-start) 0%, var(--bg-end) 100%);
			}

			.wrap {
				max-width: 1180px;
				margin: 0 auto;
				padding: 20px 16px 32px;
				display: grid;
				gap: 14px;
			}

			.panel {
				background: var(--panel);
				backdrop-filter: blur(8px);
				border: 1px solid var(--line);
				border-radius: 14px;
				box-shadow: 0 8px 30px rgba(15, 23, 42, 0.08);
			}

			.header {
				padding: 16px 18px;
				display: flex;
				flex-wrap: wrap;
				gap: 10px;
				align-items: center;
				justify-content: space-between;
			}

			h1 {
				margin: 0;
				font-size: 20px;
				letter-spacing: 0.02em;
			}

			.tag {
				display: inline-flex;
				align-items: center;
				gap: 8px;
				font-size: 12px;
				font-family: var(--mono);
				border: 1px solid var(--line);
				border-radius: 999px;
				padding: 6px 10px;
				background: var(--panel-strong);
				color: var(--muted);
			}

			form {
				padding: 14px 18px 18px;
				display: grid;
				grid-template-columns: 1fr;
				gap: 12px;
			}

			.form-group {
				margin: 0;
				padding: 12px;
				border: 1px solid var(--line);
				border-radius: 10px;
				background: var(--panel-strong);
			}

			.form-group legend {
				padding: 0 6px;
				font-size: 12px;
				font-weight: 700;
				color: var(--muted);
			}

			.group-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
				gap: 12px;
			}

			.form-advanced {
				border: 1px solid var(--line);
				border-radius: 10px;
				background: var(--panel-strong);
				padding: 8px 10px 10px;
			}

			.form-advanced > summary {
				cursor: pointer;
				font-size: 12px;
				font-weight: 700;
				color: var(--muted);
				user-select: none;
			}

			.advanced-sections {
				display: grid;
				gap: 10px;
				margin-top: 10px;
			}

			label {
				display: grid;
				gap: 6px;
				font-size: 12px;
				color: var(--muted);
			}

			.label-title {
				display: inline-flex;
				align-items: center;
				gap: 4px;
				line-height: 1.2;
			}

			.help-trigger {
				position: relative;
				display: inline-flex;
				align-items: center;
				justify-content: center;
				flex: 0 0 auto;
				width: 14px;
				height: 14px;
				padding: 0;
				border: 1px solid #93a3b3;
				border-radius: 999px;
				background: #fff;
				color: #64748b;
				font-size: 10px;
				font-weight: 700;
				line-height: 1;
				cursor: pointer;
			}

			.help-trigger::before,
			.help-trigger::after {
				opacity: 0;
				pointer-events: none;
				transition: opacity 0.12s ease;
			}

			.help-trigger::before {
				content: "";
				position: absolute;
				top: calc(100% + 2px);
				left: 50%;
				transform: translateX(-50%);
				border-left: 6px solid transparent;
				border-right: 6px solid transparent;
				border-bottom: 6px solid #1f2937;
				z-index: 5;
			}

			.help-trigger::after {
				content: attr(data-help);
				position: absolute;
				top: calc(100% + 8px);
				left: 50%;
				transform: translateX(-50%);
				z-index: 4;
				width: 230px;
				max-width: min(230px, 70vw);
				padding: 8px 10px;
				border-radius: 8px;
				background: #1f2937;
				color: #f8fafc;
				font-size: 11px;
				font-weight: 400;
				text-align: left;
				white-space: normal;
			}

			.help-trigger:focus-visible::before,
			.help-trigger:focus-visible::after,
			.help-trigger.is-open::before,
			.help-trigger.is-open::after {
				opacity: 1;
			}

			.file-dropzone {
				position: relative;
				min-height: 92px;
				border: 2px dashed #8aa3b8;
				border-radius: 12px;
				background: #f8fbff;
				display: grid;
				place-items: center;
				text-align: center;
				padding: 10px;
				transition: border-color 0.12s ease, background-color 0.12s ease;
			}

			.file-dropzone.is-dragging {
				border-color: #0f766e;
				background: #edfdf8;
			}

			.file-drop-text {
				font-size: 12px;
				color: #4b5563;
				pointer-events: none;
			}

			.file-drop-text strong {
				display: block;
				color: #1f2937;
				font-size: 13px;
				margin-bottom: 4px;
			}

			.file-input-overlay {
				position: absolute;
				inset: 0;
				opacity: 0;
				cursor: pointer;
				border: 0;
				padding: 0;
				margin: 0;
				width: 100%;
				height: 100%;
			}

			input,
			select,
			textarea,
			button {
				font: inherit;
			}

			input,
			select,
			textarea {
				width: 100%;
				border: 1px solid var(--line);
				border-radius: 10px;
				padding: 9px 10px;
				background: #fff;
				color: var(--ink);
				font-size: 14px;
			}

			textarea {
				resize: vertical;
				min-height: 110px;
				font-family: var(--mono);
			}

			.span-2 {
				grid-column: span 2;
			}

			.actions {
				display: flex;
				align-items: center;
				gap: 10px;
				grid-column: 1 / -1;
			}

			button {
				border: 0;
				border-radius: 10px;
				padding: 10px 18px;
				background: var(--accent);
				color: #fff;
				font-weight: 600;
				cursor: pointer;
			}

			button:disabled {
				opacity: 0.6;
				cursor: not-allowed;
			}

			.button-secondary {
				background: #b45309;
			}

			.note {
				font-size: 12px;
				color: var(--muted);
			}

			.result-head {
				padding: 14px 18px;
				border-bottom: 1px solid var(--line);
				display: flex;
				flex-wrap: wrap;
				gap: 8px;
				align-items: center;
			}

			.button-copy {
				margin-left: auto;
				border: 1px solid var(--line);
				border-radius: 999px;
				padding: 6px 12px;
				background: var(--panel-strong);
				color: var(--muted);
				font-size: 12px;
				font-weight: 600;
			}

			.button-copy.copied {
				background: var(--accent);
				border-color: var(--accent);
				color: #fff;
			}

			.page-picker {
				padding: 12px 18px 0;
				display: flex;
				align-items: center;
				gap: 10px;
			}

			.page-picker label {
				display: block;
				font-size: 12px;
				color: var(--muted);
				min-width: fit-content;
			}

			.page-picker select {
				max-width: 240px;
			}

			.result-body {
				padding: 14px 18px 18px;
				display: grid;
				gap: 12px;
			}

			.card {
				border: 1px solid var(--line);
				border-radius: 10px;
				background: var(--panel-strong);
				padding: 12px;
			}

			pre {
				margin: 0;
				font-family: var(--mono);
				font-size: 12px;
				line-height: 1.55;
				white-space: pre-wrap;
				word-break: break-word;
			}

			details summary {
				cursor: pointer;
				color: var(--warn);
				font-size: 12px;
				margin-bottom: 8px;
			}

			.preview-image {
				width: 100%;
				height: auto;
				border: 1px solid var(--line);
				border-radius: 8px;
				background: #fff;
			}

			.block-table-wrap {
				overflow-x: auto;
			}

			.block-table {
				width: 100%;
				border-collapse: collapse;
				font-size: 12px;
				font-family: var(--mono);
			}

			.block-table th,
			.block-table td {
				border: 1px solid var(--line);
				padding: 6px 8px;
				vertical-align: top;
			}

			.block-table th {
				background: #f4f7fb;
				font-weight: 600;
				text-align: left;
			}

			.hidden {
				display: none;
			}

			@media (max-width: 760px) {
				.span-2 {
					grid-column: span 1;
				}
			}
		</style>
	</head>
	<body>
		<div class="wrap">
			<section class="panel">
				<div class="header">
					<h1>GLM-OCR Local Console</h1>
					<div style="display: flex; gap: 8px; flex-wrap: wrap">
						<span class="tag" id="statusModel">model: -</span>
						<span class="tag" id="statusDevice">device: -</span>
						<span class="tag" id="statusCuda">cuda: -</span>
					</div>
				</div>
					<form id="analyzeForm">
						<fieldset class="form-group">
							<legend>输入</legend>
							<div class="group-grid">
								<label class="span-2">
								<span class="label-title"
									>文件 (图像/PDF)
							<button
								class="help-trigger"
									type="button"
									data-help="待分析的文件。PDF会按页展开进行OCR。"
									aria-label="文件说明"
								>
									?
								</button>
							</span>
							<div class="file-dropzone" id="fileDropzone">
								<div class="file-drop-text" id="fileDropText">
									<strong>拖放文件</strong>
									或点击选择文件
								</div>
										<input
											id="file"
											name="file"
											type="file"
											class="file-input-overlay"
											accept=".pdf,image/*"
											required
										/>
									</div>
								</label>
								<label>
									<span class="label-title"
										>task
							<button
								class="help-trigger"
								type="button"
								data-help="指定识别类型。从text/table/formula/extract_json中选择。"
								aria-label="task说明"
							>
								?
							</button>
						</span>
						<select id="task" name="task">
							<option value="text" selected>Text</option>
							<option value="table">Table</option>
							<option value="formula">Formula</option>
							<option value="extract_json">JSON提取</option>
						</select>
								</label>
								<label id="schemaWrap" class="span-2 hidden">
									<span class="label-title"
										>schema (JSON Schema string)
							<button
								class="help-trigger"
								type="button"
								data-help="当task为extract_json时必填。通过 schema 指定想要输出的 JSON 结构。"
								aria-label="schema说明"
							>
								?
							</button>
						</span>
									<textarea
										id="schema"
										name="schema"
										placeholder='{"type":"object","properties":{"name":{"type":"string"}}}'
									></textarea>
								</label>
							</div>
						</fieldset>

						<details class="form-advanced">
							<summary>详细设置</summary>
							<div class="advanced-sections">
								<fieldset class="form-group">
									<legend>布局OCR</legend>
									<div class="group-grid">
										<label>
											<span class="label-title"
												>区域分割OCR
							<button
								class="help-trigger"
								type="button"
								data-help="开启后会在布局分析后按区域进行OCR。适用于防止多栏、竖排文档的阅读顺序混乱。"
								aria-label="区域分割OCR说明"
							>
								?
							</button>
						</span>
						<select id="use_layout" name="use_layout">
							<option value="false" selected>OFF (传统页面OCR)</option>
							<option value="true">ON (PP-DocLayoutV3)</option>
						</select>
										</label>
										<label>
											<span class="label-title"
												>layout backend
							<button
								class="help-trigger"
								type="button"
								data-help="布局分析器。推荐使用ppdoclayoutv3。none会将整个页面视为一个区域。"
								aria-label="layout backend说明"
							>
								?
							</button>
						</span>
											<select id="layout_backend" name="layout_backend">
												<option value="ppdoclayoutv3" selected>ppdoclayoutv3</option>
												<option value="none">none</option>
											</select>
										</label>
										<label>
											<span class="label-title"
												>reading_order
							<button
								class="help-trigger"
								type="button"
								data-help="区域的合并顺序。auto为自动推定，ltr_ttb为从左到右，rtl_ttb为从右到左，vertical_rl为竖排右列优先。"
								aria-label="reading_order说明"
							>
								?
							</button>
						</span>
											<select id="reading_order" name="reading_order">
												<option value="auto" selected>auto</option>
												<option value="ltr_ttb">ltr_ttb</option>
												<option value="rtl_ttb">rtl_ttb</option>
												<option value="vertical_rl">vertical_rl</option>
											</select>
										</label>
										<label>
											<span class="label-title"
												>region_padding(px)
							<button
								class="help-trigger"
								type="button"
								data-help="添加到各区域外侧的边距。有助于防止文字被截断，但过大可能导致相邻区域混淆。"
								aria-label="region_padding说明"
							>
								?
							</button>
						</span>
											<input
												id="region_padding"
												name="region_padding"
												type="number"
												min="0"
												max="256"
												value="12"
											/>
										</label>
										<label>
											<span class="label-title"
												>max_regions
							<button
								class="help-trigger"
								type="button"
								data-help="单页处理的区域上限。用于防止异常，超出部分会被截断。"
								aria-label="max_regions说明"
							>
								?
							</button>
						</span>
											<input
												id="max_regions"
												name="max_regions"
												type="number"
												min="1"
												max="1000"
												value="200"
											/>
										</label>
										<label>
											<span class="label-title"
												>region_parallelism
							<button
								class="help-trigger"
								type="button"
								data-help="同时运行的区域推理数。1最为安全，增加可能会加快速度但会增加VRAM使用量。"
								aria-label="region_parallelism说明"
							>
								?
							</button>
						</span>
											<input
												id="region_parallelism"
												name="region_parallelism"
												type="number"
												min="1"
												max="8"
												value="1"
											/>
										</label>
									</div>
								</fieldset>

								<fieldset class="form-group">
									<legend>品质</legend>
									<div class="group-grid">
										<label>
											<span class="label-title"
												>换行处理
							<button
								class="help-trigger"
								type="button"
								data-help="OCR后的换行整形模式。none为保持原样，paragraph为维持段落，compact为强烈压缩换行。"
								aria-label="换行处理说明"
							>
								?
							</button>
						</span>
						<select id="linebreak_mode" name="linebreak_mode">
							<option value="none" selected>不处理</option>
							<option value="paragraph">段落整形（空行维持）</option>
							<option value="compact">强力整形（换行几乎去除）</option>
						</select>
										</label>
										<label>
											<span class="label-title"
												>dpi (PDF only)
							<button
								class="help-trigger"
								type="button"
								data-help="PDF转换为图像的分辨率。越高越精细，但会增加处理时间和内存消耗。"
								aria-label="dpi说明"
							>
								?
							</button>
						</span>
											<input
												id="dpi"
												name="dpi"
												type="number"
												min="72"
												max="600"
												value="220"
											/>
										</label>
										<label>
											<span class="label-title"
												>max_new_tokens
							<button
								class="help-trigger"
								type="button"
								data-help="单次生成的token上限。越大可以返回越长的文本，但会更慢。"
								aria-label="max_new_tokens说明"
							>
								?
							</button>
						</span>
											<input
												id="max_new_tokens"
												name="max_new_tokens"
												type="number"
												min="1"
												max="32768"
												value="1024"
											/>
										</label>
										<label>
											<span class="label-title"
												>temperature
							<button
								class="help-trigger"
								type="button"
								data-help="生成的随机性。0最具确定性，值越大越多样。"
								aria-label="temperature说明"
							>
								?
							</button>
						</span>
											<input
												id="temperature"
												name="temperature"
												type="number"
												step="0.1"
												min="0"
												max="2"
												value="0"
											/>
										</label>
									</div>
								</fieldset>

								<fieldset class="form-group">
									<legend>执行</legend>
									<div class="group-grid">
										<label>
											<span class="label-title"
												>device
							<button
								class="help-trigger"
								type="button"
								data-help="用于推理的计算设备。auto会在CUDA可用时选择GPU，不可用时选择CPU。"
								aria-label="device说明"
							>
								?
							</button>
						</span>
											<select id="device" name="device">
												<option value="auto" selected>auto</option>
												<option value="cuda">cuda</option>
												<option value="cpu">cpu</option>
											</select>
										</label>
									</div>
								</fieldset>
							</div>
						</details>
						<div class="actions">
							<button id="submitBtn" type="submit">执行</button>
						<button
						id="cancelBtn"
						class="button-secondary hidden"
						type="button"
						disabled
					>
						中断
					</button>
					<span class="note" id="requestNote">等待中</span>
					</div>
				</form>
			</section>

				<section class="panel">
					<div class="result-head">
						<span class="tag" id="resultTask">task: -</span>
						<span class="tag" id="resultLinebreak">linebreak: -</span>
						<span class="tag" id="resultPages">pages: -</span>
						<span class="tag" id="resultDevice">run device: -</span>
						<span class="tag" id="resultLayout">layout: -</span>
						<span class="tag" id="resultOrder">order: -</span>
						<button id="copyBtn" class="button-copy" type="button" disabled>
						复制
					</button>
					</div>
				<div class="page-picker hidden" id="pagePickerWrap">
					<label for="pageSelect">显示页面</label>
					<select id="pageSelect"></select>
				</div>
				<div class="result-body" id="resultBody">
					<div class="card">
						<pre>这里将显示分析结果。</pre>
					</div>
				</div>
			</section>
		</div>

		<script>
			const form = document.getElementById("analyzeForm");
			const submitBtn = document.getElementById("submitBtn");
				const cancelBtn = document.getElementById("cancelBtn");
				const copyBtn = document.getElementById("copyBtn");
				const requestNote = document.getElementById("requestNote");
				const fileInput = document.getElementById("file");
				const fileDropzone = document.getElementById("fileDropzone");
				const fileDropText = document.getElementById("fileDropText");
				const taskInput = document.getElementById("task");
			const schemaWrap = document.getElementById("schemaWrap");
			const schemaInput = document.getElementById("schema");
			const useLayoutInput = document.getElementById("use_layout");
			const layoutBackendInput = document.getElementById("layout_backend");
			const readingOrderInput = document.getElementById("reading_order");
			const regionPaddingInput = document.getElementById("region_padding");
			const maxRegionsInput = document.getElementById("max_regions");
			const regionParallelismInput = document.getElementById("region_parallelism");
			const pagePickerWrap = document.getElementById("pagePickerWrap");
			const pageSelect = document.getElementById("pageSelect");
			const resultBody = document.getElementById("resultBody");

			const statusModel = document.getElementById("statusModel");
			const statusDevice = document.getElementById("statusDevice");
			const statusCuda = document.getElementById("statusCuda");
			const resultTask = document.getElementById("resultTask");
			const resultLinebreak = document.getElementById("resultLinebreak");
			const resultPages = document.getElementById("resultPages");
			const resultDevice = document.getElementById("resultDevice");
			const resultLayout = document.getElementById("resultLayout");
			const resultOrder = document.getElementById("resultOrder");

			let currentResults = [];
			let progressPollTimer = null;
			let activeRequestId = null;
			let currentViewItem = null;
			let currentViewLabel = "";
			let copyFeedbackTimer = null;
				let currentMeta = {
					useLayout: false,
					readingOrder: "auto",
					layoutBackend: "-",
				};
				const helpTriggers = Array.from(document.querySelectorAll(".help-trigger"));

				function closeHelpBubbles(except = null) {
					helpTriggers.forEach((btn) => {
						if (except && btn === except) {
							return;
						}
						btn.classList.remove("is-open");
						btn.setAttribute("aria-expanded", "false");
					});
				}

				function setupHelpBubbles() {
					helpTriggers.forEach((btn) => {
						btn.setAttribute("aria-expanded", "false");
						btn.addEventListener("click", (event) => {
							event.preventDefault();
							event.stopPropagation();
							const isOpen = btn.classList.contains("is-open");
							closeHelpBubbles();
							if (!isOpen) {
								btn.classList.add("is-open");
								btn.setAttribute("aria-expanded", "true");
							}
						});
					});
					document.addEventListener("click", () => closeHelpBubbles());
					document.addEventListener("keydown", (event) => {
						if (event.key === "Escape") {
							closeHelpBubbles();
						}
					});
				}

				function updateFileDropText() {
					if (!fileDropText) {
						return;
					}
					if (fileInput && fileInput.files && fileInput.files.length > 0) {
						fileDropText.innerHTML = `<strong>已选择:</strong>${fileInput.files[0].name}`;
						return;
					}
					fileDropText.innerHTML =
						"<strong>拖放文件</strong>或点击选择文件";
				}

				function setupFileDropzone() {
					if (!fileDropzone || !fileInput) {
						return;
					}
					const onDragEnter = (event) => {
						event.preventDefault();
						fileDropzone.classList.add("is-dragging");
					};
					const onDragLeave = (event) => {
						event.preventDefault();
						if (!fileDropzone.contains(event.relatedTarget)) {
							fileDropzone.classList.remove("is-dragging");
						}
					};
					const onDragOver = (event) => {
						event.preventDefault();
						fileDropzone.classList.add("is-dragging");
					};
					const onDrop = (event) => {
						event.preventDefault();
						fileDropzone.classList.remove("is-dragging");
						const droppedFiles = event.dataTransfer && event.dataTransfer.files;
						if (!droppedFiles || droppedFiles.length === 0) {
							return;
						}
						try {
							const transfer = new DataTransfer();
							for (const droppedFile of droppedFiles) {
								transfer.items.add(droppedFile);
							}
							fileInput.files = transfer.files;
						} catch (error) {
							// Ignore browsers that disallow assignment.
						}
						updateFileDropText();
					};

					fileDropzone.addEventListener("dragenter", onDragEnter);
					fileDropzone.addEventListener("dragleave", onDragLeave);
					fileDropzone.addEventListener("dragover", onDragOver);
					fileDropzone.addEventListener("drop", onDrop);
					fileInput.addEventListener("change", updateFileDropText);
					updateFileDropText();
				}

			function taskNeedsSchema(task) {
				return task === "extract_json";
			}

			function isLayoutEnabled() {
				return useLayoutInput.value === "true";
			}

			function toggleSchema() {
				const show = taskNeedsSchema(taskInput.value);
				schemaWrap.classList.toggle("hidden", !show);
				schemaInput.required = show;
			}

			function toggleLayoutOptions() {
				const enabled = isLayoutEnabled();
				layoutBackendInput.disabled = !enabled;
				readingOrderInput.disabled = !enabled;
				regionPaddingInput.disabled = !enabled;
				maxRegionsInput.disabled = !enabled;
				regionParallelismInput.disabled = !enabled;
			}

			function setBusy(isBusy, message) {
				submitBtn.disabled = isBusy;
				const canCancel = isBusy && Boolean(activeRequestId);
				cancelBtn.disabled = !canCancel;
				cancelBtn.classList.toggle("hidden", !canCancel);
				requestNote.textContent = message;
			}

			function resetCopyState() {
					currentViewItem = null;
					currentViewLabel = "";
					copyBtn.disabled = true;
					if (copyFeedbackTimer) {
						clearTimeout(copyFeedbackTimer);
						copyFeedbackTimer = null;
					}
					copyBtn.classList.remove("copied");
					copyBtn.textContent = "复制";
			}

			function setError(message) {
				resetCopyState();
				resultBody.innerHTML = "";
				const card = document.createElement("div");
				card.className = "card";
				const pre = document.createElement("pre");
				pre.textContent = message;
				card.appendChild(pre);
				resultBody.appendChild(card);
			}

			function renderLoading(message = "分析中... 请稍候。") {
				resetCopyState();
				resultBody.innerHTML = "";
				const card = document.createElement("div");
				card.className = "card";
				const pre = document.createElement("pre");
				pre.id = "loadingText";
				pre.textContent = message;
				card.appendChild(pre);
				resultBody.appendChild(card);
			}

			function updateLoading(message) {
				const pre = document.getElementById("loadingText");
				if (pre) {
					pre.textContent = message;
				}
			}

			function createRequestId() {
				if (window.crypto && typeof window.crypto.randomUUID === "function") {
					return window.crypto.randomUUID();
				}
				return `${Date.now()}-${Math.random().toString(16).slice(2)}`;
			}

			function stopProgressPolling() {
				if (progressPollTimer) {
					clearInterval(progressPollTimer);
					progressPollTimer = null;
				}
			}

			function startProgressPolling(requestId) {
				stopProgressPolling();
				const poll = async () => {
					try {
						const res = await fetch(`/api/progress/${encodeURIComponent(requestId)}`);
						if (!res.ok) {
							return;
						}
						const payload = await res.json();
						const message = payload.message || "分析中...";
						setBusy(true, message);
						updateLoading(message);
						if (payload.total_pages && Number(payload.total_pages) > 0) {
							resultPages.textContent = `pages: ${payload.total_pages}`;
						}
						if (
							payload.state === "done" ||
							payload.state === "error" ||
							payload.state === "canceled"
						) {
							stopProgressPolling();
						}
					} catch (error) {
						// Keep silent during transient polling errors.
					}
				};
				poll();
				progressPollTimer = setInterval(poll, 500);
			}

			function renderPageSelector(results) {
				pageSelect.innerHTML = "";
				const allOption = document.createElement("option");
				allOption.value = "all";
				allOption.textContent = "ALL";
				pageSelect.appendChild(allOption);
				results.forEach((item, index) => {
					const option = document.createElement("option");
					option.value = String(index);
					option.textContent = `Page ${item.page}`;
					pageSelect.appendChild(option);
				});
				pageSelect.value = "all";
				pagePickerWrap.classList.remove("hidden");
			}

			function combineAllPages(results) {
				const text = results.map((item) => `[Page ${item.page}]\n${item.text || ""}`).join("\n\n");
				const raw = results.map((item) => `[Page ${item.page}]\n${item.raw || ""}`).join("\n\n");
				const json = results
					.filter((item) => item.json !== null && item.json !== undefined)
					.map((item) => ({ page: item.page, json: item.json }));
				const errors = results
					.filter((item) => item.error)
					.map((item) => `[Page ${item.page}] ${item.error}`);
				return {
					text,
					raw,
					json: json.length > 0 ? json : null,
					error: errors.length > 0 ? errors.join("\n") : null,
				};
			}

			function createCard(title, content = null) {
				const card = document.createElement("div");
				card.className = "card";
				if (title) {
					const strong = document.createElement("strong");
					strong.textContent = title;
					card.appendChild(strong);
					card.appendChild(document.createElement("hr"));
				}
				if (content) {
					card.appendChild(content);
				}
				return card;
			}

				function renderBlocksTable(blocks) {
					const wrap = document.createElement("div");
					wrap.className = "block-table-wrap";
					const table = document.createElement("table");
					table.className = "block-table";
				const thead = document.createElement("thead");
				thead.innerHTML =
					"<tr><th>ID</th><th>type</th><th>bbox</th><th>truncated</th><th>text</th></tr>";
				table.appendChild(thead);
					const tbody = document.createElement("tbody");
					blocks.forEach((block) => {
						const tr = document.createElement("tr");
						const bbox = block.bbox || {};
						const bboxText = `(${bbox.x1 ?? "-"},${bbox.y1 ?? "-"})-(${bbox.x2 ?? "-"},${bbox.y2 ?? "-"})`;
						const snippet = String(block.text || "").slice(0, 280);
						const values = [
							String(block.id || ""),
							String(block.type || ""),
							bboxText,
							String(Boolean(block.truncated)),
							snippet,
						];
						values.forEach((value) => {
							const td = document.createElement("td");
							td.textContent = value;
							tr.appendChild(td);
						});
						tbody.appendChild(tr);
					});
					table.appendChild(tbody);
					wrap.appendChild(table);
					return wrap;
			}

			function renderResultItem(item, textLabel = "text", jsonLabel = "json", copyLabel = "") {
				currentViewItem = item;
				currentViewLabel = copyLabel;
				copyBtn.disabled = false;
				if (copyFeedbackTimer) {
					clearTimeout(copyFeedbackTimer);
					copyFeedbackTimer = null;
				}
				copyBtn.classList.remove("copied");
				copyBtn.textContent = "复制";
				resultBody.innerHTML = "";

				if (item.layout_preview_base64) {
					const img = document.createElement("img");
					img.className = "preview-image";
					img.alt = "layout preview";
					img.src = `data:image/png;base64,${item.layout_preview_base64}`;
					resultBody.appendChild(createCard("layout_preview", img));
				}

				if (Array.isArray(item.blocks) && item.blocks.length > 0) {
					resultBody.appendChild(createCard("blocks", renderBlocksTable(item.blocks)));
				}

				const textPre = document.createElement("pre");
				textPre.textContent = item.text || "";
				resultBody.appendChild(createCard(textLabel, textPre));

				if (item.json !== null && item.json !== undefined) {
					const jsonPre = document.createElement("pre");
					jsonPre.textContent = JSON.stringify(item.json, null, 2);
					resultBody.appendChild(createCard(jsonLabel, jsonPre));
				}

				const rawPre = document.createElement("pre");
				rawPre.textContent = item.raw || "";
				const details = document.createElement("details");
				const summary = document.createElement("summary");
				summary.textContent = "raw (debug)";
				details.appendChild(summary);
				details.appendChild(rawPre);
				const rawCard = createCard("", details);
				if (item.error) {
					const err = document.createElement("pre");
					err.textContent = item.error;
					rawCard.appendChild(err);
				}
				resultBody.appendChild(rawCard);
			}

			function renderPage(index) {
				const item = currentResults[index];
				if (!item) {
					setError("未找到结果页面。");
					return;
				}
				if (item.reading_order) {
					resultOrder.textContent = `order: ${item.reading_order}`;
				}
				renderResultItem(item, "text", "json", `Page ${item.page}`);
			}

			function renderAllPages() {
				resultOrder.textContent = `order: ${currentMeta.readingOrder || "-"}`;
				renderResultItem(combineAllPages(currentResults), "text (ALL)", "json (ALL)", "ALL");
			}

			function buildCopyText(item, label) {
				if (!item) {
					return "";
				}
				const parts = [];
				if (label) {
					parts.push(`# ${label}`);
				}
				if (item.text) {
					parts.push(`[text]\n${item.text}`);
				}
				if (item.json !== null && item.json !== undefined) {
					parts.push(`[json]\n${JSON.stringify(item.json, null, 2)}`);
				}
				if (item.error) {
					parts.push(`[error]\n${item.error}`);
				}
				return parts.join("\n\n").trim();
			}

			function showCopyFeedback(message, copied = false) {
				requestNote.textContent = message;
				if (copyFeedbackTimer) {
					clearTimeout(copyFeedbackTimer);
					copyFeedbackTimer = null;
				}
				copyBtn.classList.toggle("copied", copied);
				copyBtn.textContent = copied ? "コピー済み" : "コピー";
				if (copied) {
					copyFeedbackTimer = setTimeout(() => {
						copyBtn.classList.remove("copied");
						copyBtn.textContent = "复制";
						copyFeedbackTimer = null;
					}, 1200);
				}
			}

			async function copyCurrentView() {
				const text = buildCopyText(currentViewItem, currentViewLabel);
				if (!text) {
					return;
				}
				try {
					await navigator.clipboard.writeText(text);
					showCopyFeedback("コピーしました", true);
				} catch (error) {
					const textarea = document.createElement("textarea");
					textarea.value = text;
					textarea.style.position = "fixed";
					textarea.style.opacity = "0";
					document.body.appendChild(textarea);
					textarea.focus();
					textarea.select();
					try {
						document.execCommand("copy");
						showCopyFeedback("コピーしました", true);
					} catch (fallbackError) {
						showCopyFeedback("コピーに失敗しました", false);
					} finally {
						document.body.removeChild(textarea);
					}
				}
			}

			async function fetchStatus() {
				try {
					const res = await fetch("/api/status");
					const payload = await res.json();
					statusModel.textContent = `model: ${payload.model || "-"}`;
					statusDevice.textContent = `device default: ${payload.device_default || "-"}`;
					statusCuda.textContent = `cuda: ${String(payload.cuda_available)}`;
					const cudaOption = document.querySelector('#device option[value="cuda"]');
					if (cudaOption) {
						cudaOption.disabled = !payload.cuda_available;
						if (!payload.cuda_available && document.getElementById("device").value === "cuda") {
							document.getElementById("device").value = "auto";
						}
					}
				} catch (error) {
					statusCuda.textContent = "cuda: status unavailable";
				}
			}

			form.addEventListener("submit", async (event) => {
				event.preventDefault();
				if (!fileInput.files || fileInput.files.length === 0) {
										setError("请选择文件。");
										return;
									}

				const formData = new FormData();
				const requestId = createRequestId();
				activeRequestId = requestId;
				formData.append("file", fileInput.files[0]);
				formData.append("device", document.getElementById("device").value);
				formData.append("dpi", document.getElementById("dpi").value);
				formData.append("task", taskInput.value);
				formData.append("linebreak_mode", document.getElementById("linebreak_mode").value);
				formData.append("max_new_tokens", document.getElementById("max_new_tokens").value);
				formData.append("temperature", document.getElementById("temperature").value);
				formData.append("use_layout", useLayoutInput.value);
				formData.append("layout_backend", layoutBackendInput.value);
				formData.append("reading_order", readingOrderInput.value);
				formData.append("region_padding", regionPaddingInput.value);
				formData.append("max_regions", maxRegionsInput.value);
				formData.append("region_parallelism", regionParallelismInput.value);
				formData.append("request_id", requestId);
				if (taskNeedsSchema(taskInput.value)) {
					formData.append("schema", schemaInput.value);
				}

				setBusy(true, "预处理中");
									pageSelect.innerHTML = "";
									pagePickerWrap.classList.add("hidden");
									resetCopyState();
									currentResults = [];
									resultTask.textContent = `task: ${taskInput.value}`;
									resultLinebreak.textContent = `linebreak: ${document.getElementById("linebreak_mode").value}`;
									resultPages.textContent = "pages: -";
									resultDevice.textContent = "run device: -";
									resultLayout.textContent = `layout: ${useLayoutInput.value}`;
									resultOrder.textContent = `order: ${readingOrderInput.value}`;
									renderLoading("预处理中");
				startProgressPolling(requestId);

				try {
					const res = await fetch("/api/analyze", { method: "POST", body: formData });
					const payload = await res.json();
					if (!res.ok) {
						throw new Error(payload.detail || "API request failed");
					}
					stopProgressPolling();
					activeRequestId = null;

					currentResults = Array.isArray(payload.results) ? payload.results : [];
					currentMeta = {
						useLayout: Boolean(payload.use_layout),
						readingOrder: payload.reading_order || "-",
						layoutBackend: payload.layout_backend || "-",
					};
					resultTask.textContent = `task: ${payload.task || "-"}`;
					resultLinebreak.textContent = `linebreak: ${payload.linebreak_mode || "-"}`;
					resultPages.textContent = `pages: ${payload.page_count || 0}`;
					resultDevice.textContent = `run device: ${payload.device || "-"}`;
					resultLayout.textContent = `layout: ${String(Boolean(payload.use_layout))} (${payload.layout_backend || "-"})`;
					resultOrder.textContent = `order: ${payload.reading_order || "-"}`;

					if (currentResults.length === 0) {
											if (payload.state === "canceled") {
												setError("已中断。");
											} else {
												setError("结果为空。");
											}
										} else {
											renderPageSelector(currentResults);
											renderAllPages();
										}
										if (payload.state === "canceled") {
											setBusy(false, "中断");
										} else {
											setBusy(false, "完成");
										}
				} catch (error) {
					stopProgressPolling();
					activeRequestId = null;
					setError(`错误: ${error.message}`);
									setBusy(false, "失败");
				}
			});

			cancelBtn.addEventListener("click", async () => {
				if (!activeRequestId) {
					return;
				}
				const requestId = activeRequestId;
				cancelBtn.disabled = true;
									requestNote.textContent = "中断请求中...";
									updateLoading("中断请求中...");
									try {
										const res = await fetch(`/api/cancel/${encodeURIComponent(requestId)}`, {
											method: "POST",
										});
										const payload = await res.json();
										if (!res.ok) {
											throw new Error(payload.detail || "中断请求失败");
										}
										requestNote.textContent = payload.message || "已接受中断请求";
										updateLoading(payload.message || "已接受中断请求");
				} catch (error) {
					requestNote.textContent = `中断请求失败: ${error.message}`;
					if (activeRequestId) {
						cancelBtn.disabled = false;
					}
				}
			});

			pageSelect.addEventListener("change", () => {
				if (pageSelect.value === "all") {
					renderAllPages();
					return;
				}
				const index = Number(pageSelect.value);
				if (Number.isNaN(index)) {
					renderAllPages();
					return;
				}
				renderPage(index);
			});

			copyBtn.addEventListener("click", () => {
				void copyCurrentView();
			});

			taskInput.addEventListener("change", toggleSchema);
			useLayoutInput.addEventListener("change", toggleLayoutOptions);
			toggleSchema();
			toggleLayoutOptions();
			setupHelpBubbles();
			setupFileDropzone();
			fetchStatus();
		</script>
	</body>
</html>
